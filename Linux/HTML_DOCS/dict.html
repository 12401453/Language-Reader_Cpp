<!DOCTYPE html> 
<html>

<head>
  <link href="dict.css" rel="stylesheet" type="text/css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script>
    let changed = false;
    const switchIcon = () => {
        if(changed) {
            document.getElementById('dict_logo').src = 'enwiktionary_grey.png';
            document.getElementById('dict_logo').title = 'Wiktionary';
            changed = false;
        }
        else {
            document.getElementById('dict_logo').src = 'PONS.ico';
            document.getElementById('dict_logo').title = 'PONS.com';
            changed = true;
        }
    };
  </script>
</head>

<body style="background-color: #172136;">

<div id="dict_outline">
 <div id="dict_topbar"></div>
 <div id="dict_body">
  <div class="dict_row"><div class="dict_cell left">koń by się uśmiał</div><div class="dict_cell right">don't make me laugh</div></div>
  <div class="dict_row"><div class="dict_cell left">koń by się uśmiał</div><div class="dict_cell right">don't make me laugh</div></div>
  <div class="dict_row"><div class="dict_cell left">koń by się uśmiał</div><div class="dict_cell right">don't make me laugh</div></div>
  <div class="dict_row"><div class="dict_cell left">koń by się uśmiał</div><div class="dict_cell right">don't make me laugh</div></div>
  <div class="dict_row"><div class="dict_cell left">koń by się uśmiał</div><div class="dict_cell right">don't make me laugh</div></div>
  <div class="dict_row"><div class="dict_cell left">koń by się uśmiał</div><div class="dict_cell right">don't make me laugh</div></div>
  <div class="dict_row"><div class="dict_cell left">koń by się uśmiał</div><div class="dict_cell right">don't make me laugh</div></div>
 </div>
 <div id="dict_bottombar">
    <textarea id="dict_searchbox"></textarea>
    <img id="dict_logo" src="enwiktionary_grey.png" title="Wiktionary" onclick="switchIcon()"></img>
 </div>
 </div>

</body>
<script>

    const submitDict = (event) => {
        if(event.key == "Enter") {
            
            dictLookupPolish(event.target.value.trim());
            document.getElementById("dict_body").innerHTML = "";
            event.preventDefault();
            event.target.value = "";
        }
    };
    document.getElementById("dict_searchbox").addEventListener("keydown", submitDict);

    let dict_result_PONS = Object.create(null);

    const scrapePONS = (PONS_html) => {
    dict_result_PONS = {
        beispielsaetze: {
        },
    };
    const parser = new DOMParser();
    const PONS_page = parser.parseFromString(PONS_html, "text/html");

    if(PONS_page.getElementsByClassName("fuzzysearch").length > 0) {
        console.log("exact word not found");
        return;
    }

    const extractText = (node_list) => {
        let text = "";
        node_list.forEach(node => {
        if(node.nodeType == 1 && node.matches(".case, .info, .rhetoric, .genus, .style")) {
            text += "[" + node.textContent + "]";
        }
        else if(node.nodeType == 1 && node.matches(".collocator")) {
            text += "(" + node.textContent + ")";
        }
        else if(/^\s+$/.test(node.textContent)) {        
            text += " ";
        }
        else {
            text += node.textContent;
        }
        });
        return text.trim();
    };

    let meaning_sections = PONS_page.querySelectorAll(".rom");
    let rom_lngth = meaning_sections.length;
    for(let i = 0; i < rom_lngth; i++) {
        if(meaning_sections[i].querySelector(".signature-od") == null) {
        dict_result_PONS[i] = {};
        let blocks = meaning_sections[i].querySelectorAll(".translations"); //.opened"); this second .opened class seems to not appear when cURL-ing the page
        let block_lngth = blocks.length;
        for(let j = 0; j < block_lngth; j++) {
            if(isNaN(Number(blocks[j].querySelector("h3").textContent.trim().substring(0,1)))) {
            dict_result_PONS[i].wendungen = {};
            let entries_pl = blocks[j].querySelectorAll(".dt-inner > .source"); //the > means get only the first child with specified class instead of further grandchildren
            let entries_eng = blocks[j].querySelectorAll(".dd-inner > .target");
            let entries_lngth = entries_pl.length;
            for(let k = 0; k < entries_lngth; k++) {                      
                let pl_entry = extractText(entries_pl[k].childNodes);
                let eng_entry = extractText(entries_eng[k].childNodes);
                dict_result_PONS[i].wendungen[k] = [pl_entry, eng_entry];
            }
            }
            else {
            dict_result_PONS[i][j] = {};
            let entries_pl = blocks[j].querySelectorAll(".dt-inner > .source");
            let entries_eng = blocks[j].querySelectorAll(".dd-inner > .target");
            let entries_lngth = entries_pl.length;
            for(let k = 0; k < entries_lngth; k++) {   
                let pl_entry = extractText(entries_pl[k].childNodes);
                let eng_entry = extractText(entries_eng[k].childNodes);
                dict_result_PONS[i][j][k] = [pl_entry, eng_entry];
            }
            }
        }
        }
    }
    let beispielsatz_block = PONS_page.querySelector(".results-dict-examples");
    if(beispielsatz_block != null) {
        let beispiele_pl = beispielsatz_block.querySelectorAll(".dt-inner > .source");
        let beispiele_eng = beispielsatz_block.querySelectorAll(".dd-inner > .target");
        let beispiele_lngth = beispiele_pl.length;
        for(let i = 0; i < beispiele_lngth; i++) {
        dict_result_PONS.beispielsaetze[i] = [extractText(beispiele_pl[i].childNodes), extractText(beispiele_eng[i].childNodes)];
        }
    }
    };

    
    function dictLookupPolish(word, german=false) {
    let send_data = "";
    if(german) send_data = "url=https://de.pons.com/%C3%BCbersetzung/polnisch-deutsch/"+encodeURIComponent(word);
    else send_data = "url=https://de.pons.com/%C3%BCbersetzung/polnisch-englisch/"+encodeURIComponent(word);
    const httpRequest = (method, url) => {
    
        const xhttp = new XMLHttpRequest();
        xhttp.open(method, url, true);
        xhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhttp.responseType = 'text';
        xhttp.onreadystatechange = () => {
    
            if (xhttp.readyState == 4) {
            scrapePONS(xhttp.responseText);
            console.log("curl complete");
            unpackDictResult(dict_result_PONS);
            }
    
        }
    
        xhttp.send(send_data);
    };
    
    httpRequest("POST", "curl_lookup.php");
    
    }

    const unpackDictResult = (dict_result) => {
        let dict_body = document.getElementById("dict_body");
        for(let i in dict_result) {
            if(i == "beispielsaetze") {
            for(let x in dict_result.beispielsaetze) {
                //console.log(dict_result.beispielsaetze[x][0] + " => " + dict_result.beispielsaetze[x][1]);
                dict_body.appendChild(document.createRange().createContextualFragment('<div class="dict_row"><div class="dict_cell left">'+dict_result.beispielsaetze[x][0]+'</div><div class="dict_cell right">'+dict_result.beispielsaetze[x][1]+'</div></div>'));
            }
            }
            else {
            for(let j in dict_result[i]) {
                for(let k in dict_result[i][j]) {
                //console.log(dict_result[i][j][k][0] + " => " + dict_result[i][j][k][1]);
                dict_body.appendChild(document.createRange().createContextualFragment('<div class="dict_row"><div class="dict_cell left">'+dict_result[i][j][k][0]+'</div><div class="dict_cell right">'+dict_result[i][j][k][1]+'</div></div>'));
                }
            }
            }
        }
    };
</script>
</html>